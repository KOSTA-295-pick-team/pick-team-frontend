# 외부 Nginx 설정 파일

# 백엔드 서버 그룹 정의
upstream backend_servers {
    server kosta-pick-team-backend:8081;
}

server {
    listen 80;
    # 도메인 및 ELB 헬스체크용 IP 주소 허용
    server_name www.pickteam.site pickteam.site "~^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$";

    # ==================================================
    # == API 관련 모든 규칙 (SSE, 업로드 포함)        ==
    # ==================================================

    # 워크스페이스 아이콘 업로드 (10M)
    location ~ ^/api/workspaces/[0-9]+/icon$ {
        client_max_body_size 10M;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 채팅 파일 업로드 (50M)
    location ~ ^/api/workspaces/[0-9]+/chat-rooms/[0-9]+/messages/upload$ {
        client_max_body_size 50M;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SSE 전용 설정
    location /api/sse/ {
        proxy_pass http://backend_servers;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 600s; # 타임아웃 길게 설정
    }

    # 나머지 모든 API
    location /api/ {
        client_max_body_size 10M;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==================================================
    # == WebSocket 연결 (화상회의 채팅)                ==
    # ==================================================
    location /ws {
        proxy_pass http://backend_servers;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }


    # ==================================================
    # == Livekit 주소                                 ==
    # ==================================================
      location /livekit/ {
        proxy_pass http://livekit:7880/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }


    # ==================================================
    # == 업로드된 파일 서빙                           ==
    # ==================================================
    location /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # ==================================================
    # == React 앱으로의 프록시                        ==
    # ==================================================
    location / {
        proxy_pass http://pickteam-react-app:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}